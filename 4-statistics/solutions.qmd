--- 
title: "Statistics - Worked Solutions"
format:
  html:
    code-fold: true
---

This page presents the worked solutions for the statistics tasks, showing how to perform the same analyses in both R and Python.

## Task 1: Excel Data Analysis

This task involves reading data from an Excel file (`ParkRunPerformanceData.xlsx`), cleaning it, calculating summaries, and visualizing the distribution of run times.

::: panel-tabset

### R

```{sh}
# Check if RScript is available and if so run the R code
$r_available <- Sys.which("Rscript") != ""
# Run tasks if available
if ($r_available) {
  RScript --vanilla task_excel.R
  RScript --vanilla task_excel_debug.R
  RScript --vanilla task_spss.R
  RScript --vanilla task_spss_debug.R

}
```

### Python

```{sh}
#| label: excel-task-py-run
#| warning: false
# Check if python3 is available
if which python3 > /dev/null; then
  python3 task_excel.py
  python3 task_spss.py
fi
ax.xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m'))
plt.title("Run Times over Date")
plt.show()
```

:::

## Task 2: SPSS Data Analysis

This task analyzes running data originally handled in SPSS (`RunningData.xlsx`), including filtering, grouping, and statistical tests.

::: panel-tabset

### R

```{r}
#| label: spss-task-r
#| warning: false
#| message: false

library(tidyverse)
library(readxl)

path_to_file <- "../00_data/RunningData.xlsx"
data <- read_excel(path = path_to_file, sheet = "Sheet1")

# Rename columns
names(data) <- c("position", "time", "age_cat", "gender", "prev_runs")

# Summaries
summary(data$time)
unique(data$age_cat)

# Subset only adults 
children_cats <- c("10","11-14","15-17")
data_adults <- data |> 
  filter(!age_cat %in% children_cats)

unique(data_adults$age_cat)
summary(data_adults$time)

# Analysis by gender
data_adults |> 
  group_by(gender) |> 
  summarise(min = min(time),
            mean = mean(time),
            median = mean(time),
            max = max(time))

# Comparing distributions
data_adults |> 
  ggplot(aes(x = time, fill = gender))+
  geom_histogram(col = "white")+
  facet_grid(gender~.)

data_adults |> 
  ggplot(aes(x = time, col = gender))+
  geom_boxplot()

# Statistical tests
times_female <- data_adults |> filter(gender == "F") |> pull(time)
times_male <- data_adults |> filter(gender == "M") |> pull(time)

t.test(times_male, times_female)

# Previous runs vs times
data_adults |> 
  ggplot(aes(x = prev_runs, y = time))+
  geom_point()+
  geom_smooth(method = "lm")

cor.test(data_adults$time, data_adults$prev_runs)

# Linear Model
# Extract first two digits of age category for numeric age proxy
data_adults_lm <- data_adults |> 
  mutate(age = str_extract(age_cat, '^\\d{2}') |> as.numeric())  

my_linear_model <- lm(formula = "time ~ age + gender + prev_runs", data = data_adults_lm) 
summary(my_linear_model)
```

### Python

```{python}
#| label: spss-task-py
#| warning: false

import polars as pl
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
import scipy.stats as stats
import statsmodels.formula.api as smf
import numpy as np

sns.set_theme(style="whitegrid")

path_to_file = "../00_data/RunningData.xlsx"
data = pl.from_pandas(pd.read_excel(path_to_file, sheet_name="Sheet1"))

# Rename columns
if len(data.columns) >= 5:
    data = data.rename({
        data.columns[0]: "position",
        data.columns[1]: "time",
        data.columns[2]: "age_cat",
        data.columns[3]: "gender",
        data.columns[4]: "prev_runs"
    })

print(data["time"].describe())

# Subset adults
children_cats = ["10", "11-14", "15-17"]
data_adults = data.filter(~pl.col("age_cat").is_in(children_cats))

print(data_adults["time"].describe())

# Analysis by gender
summary_gender = data_adults.group_by("gender").agg([
    pl.col("time").min().alias("min"),
    pl.col("time").mean().alias("mean"),
    pl.col("time").median().alias("median"),
    pl.col("time").max().alias("max")
])
print(summary_gender)

# Comparing distributions
g = sns.FacetGrid(data_adults.to_pandas(), row="gender", hue="gender", aspect=2, height=3)
g.map(sns.histplot, "time", edgecolor="white")
plt.show()

plt.figure()
sns.boxplot(data=data_adults.to_pandas(), x="time", hue="gender")
plt.show()

# Statistical tests
times_female = data_adults.filter(pl.col("gender") == "F")["time"]
times_male = data_adults.filter(pl.col("gender") == "M")["time"]

t_stat, p_val = stats.ttest_ind(times_male, times_female)
print(f"T-Test Results:\nt-statistic: {t_stat}\np-value: {p_val}")

# Correlation
corr, p_corr = stats.pearsonr(data_adults["time"], data_adults["prev_runs"])
print(f"Correlation: {corr}, p-value: {p_corr}")

# Linear Model
data_adults_lm = data_adults.with_columns(
    pl.col("age_cat").str.extract(r"^(\d{{2}})", 1).cast(pl.Float64).alias("age")
)

model = smf.ols(formula="time ~ age + gender + prev_runs", data=data_adults_lm.to_pandas())
results = model.fit()
print(results.summary())
```

:::
